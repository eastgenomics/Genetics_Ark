{% extends 'base.html' %}

{% load static %}

{% block body_block %}
<html>
<style>
    .spinner{
        position: relative;
        bottom: 80px;
        left: 200px;
    }

    .page_button{
        color: #fff !important;
        background: #337ab7;
        padding: 10px;
        border-radius: 5px;
        line-height: 1;
        height: 35px;
        border: none;
        transition: all 0.25s ease 0s;
        }

    .page_button:hover {
        color: #fff !important;
        transform: scale(1.1);
    }
</style>

<!-- messages loader -->
{% if messages %} 
    {% for message in messages %}
        <div class="alert {{ message.tags }} alert-dismissible" role="alert" id="message" style="position: absolute; width: 100%">
            <strong>{{ message|linebreaksbr }}</strong> 
        </div>
    {% endfor %} 
{% endif %}


<div style="width:75%; margin:0 auto; padding-top: 50px; padding-bottom: 50px;">
    
    <h2>DNAnexus to IGV</h2></br>

    Currently only newly sequenced samples processed through DNAnexus will be available to view through this instance of IGV.<br></br>

    This page may be used to generate URLs to view BAMs on IGV installed locally on your PC, or to view directly within IGV on Genetics Ark. <br></br>

    Enter the sample ID (e.g. X010000) in the search box and click search, this will return links to paste in to IGV if installed locally <br>
    on the PC, or a button to view the BAM in the web based IGV on Genetics Ark.<br></br>

    The IGV user guide may be found <a href="https://software.broadinstitute.org/software/igv/UserGuide" target="_blank">here</a>.<br></br>

    <!-- form for main search -->
    <form method="post" action="" style="padding-top:10px;" name="search_form" onsubmit="return spinner_function()">
        {% csrf_token %}
        {{ search_form.sampleID }}<br>
         
        <button name="search_form" id="search" type="submit" class="page_button">Search</button>

    </form>

    <!-- loading spinner -->
    <div id="spinner" class="spinner" style="display:none">
        <img id='spinner' src='/static/images/cloud2.gif' alt="Please wait .."  style="width:75px;height:50px;"> 
        <b>Searching DNAnexus for samples</b>
    </div>
</div>

{% if not bam_name and not bam_list %}
<!-- if normal search field used, remove direct link fields -->
<div class="well" style="width:75%; margin:0 auto; padding-bottom: 50px;">

    <h3>Load direct from URL</h3>

    To load BAMs directly in to IGV hosted on Genetics Ark please paste the BAM and index url in the respective fields below.
    This may be used for viewing samples outside of standard seqencing runs (i.e. during development work) where 
    DNAnexus links have been provided by the bioinformatics team.

    <!-- form for main search -->
    <form method="post" action="" style="padding-top:10px;" name="url_form" >
        {% csrf_token %}
        {{ url_form.bam_url_form }}<br>
        {{ url_form.idx_url_form }}<br>
        <div style="float: left; width: 17%;">
            <button name="url_form_37" type="submit" class =
                "page_button"; style="height: fit-content;">View in web IGV <br>(GRCh37)</button>
        </div>
        <div style="float: left; width: 17%;">
            <button name="url_form_38" type="submit" class =
                "page_button"; style="height: fit-content;">View in web IGV <br>(GRCh38)</button>
        </div>
    </form>

</div>
{% endif %}


{% if bam_name %}
<!-- Single BAM found for sample -->
<div class="well" style="width:75%; margin:0 auto; padding-bottom: 50px;">

    <div>
        Search term: <b>{{ sampleID }}</b><br>
        Sample Name: <b>{{ bam_name }}</b><br>
        Sequencing project: <b>{{ project_name }}</b>
        <br></br>
        BAMs may be viewed on IGV installed on PC by going to File -> Load from URL, and pasting the following links:
        <br></br>
        <ul>
            <li>BAM url: <b><span id='bam_url'>{{ bam_url }}</span></b>&nbsp;&nbsp;<input 
            type="image" src="/static/images/clipboard.png"
            onclick="CopyToClipboard('bam_url')" width="20" height="20"/></li>

            <li>Index url: <b><span id='idx_url'>{{ idx_url }}</span></b>&nbsp;&nbsp;<input 
            type="image" src="/static/images/clipboard.png"
            onclick="CopyToClipboard('idx_url')" width="20" height="20"/></li>
        </ul>
    </div>

    <br>
    Load BAMs for sample in web IGV with appropriate reference build: 
    <br></br>

    <div style="float: left; width: 17%;">
        <form action="" method="post" name="igv_form" onsubmit="return checkProject()">
            {% csrf_token %}
            <input type="hidden" name="project_name" size="10" value={{ project_name }}>
            <button name="igv_ga_37" type="submit" class =
            "page_button"; style="height: fit-content;">View in web IGV <br>(GRCh37)</button>
        </form>
    </div>
    <div style="float: left; width: 17%;">
        <form action="" method="post" style="width: 10px;" name="igv_form" onsubmit="return checkProject()">
            {% csrf_token %}
            <input type="hidden" name="project_name" width="10px" value={{ project_name }}>
            <button name="igv_ga_38" type="submit" class =
            "page_button"; style="height: fit-content;">View in web IGV <br>(GRCh38)</button>
        </form>
    </div>
</div>
{% endif %}


{% if bam_list %}
<!-- multple bams for sample returned, give option to select which to use -->

<div class="well" style="width:75%; margin:0 auto; padding-bottom: 50px;">
    <div>
        <b>{{ bam_no}}</b> BAMs found for sample <b>{{ sampleID }}</b><br>
        Please select which project to load the BAM from:</b><br></b><br>
        
        {% for bam in bam_list %}

            <form action="" method="post" name="select_bam">
                {% csrf_token %}

                <input type="hidden" name="selected_bam" value={{ bam.bam_name }} >

                <button name="select_bam" type="submit" class = "page_button">Select</button>&emsp;

                <b>{{ bam.bam_name }}</b> from project <b>{{ bam.project_name }}</b> {{ bam.bam_folder }}

            </form></b><br>

        {% endfor %}

    </div>
</div>
{% endif %}

<!-- function to check if selected sample is in the dev data project and req. confirmation to load-->
<script>
    function checkProject() {
        var x = document.forms["igv_form"]["project_name"].value;
        if (x.includes("dev")) {
            if (confirm("The selected data is for development use and must not be used for service work.\n Please confirm if you still want to load IGV.")) {
                confirm = true;
            } else {
                confirm = false;
            }
            return confirm;
        }
    }
</script>

<!-- function to display loading spinner on form submit -->
<script>
    function spinner_function() {
        var x = document.getElementById("spinner");
        if (x.style.display === "none") 
            {x.style.display = "block";}
        else 
            {x.style.display = "none";}
    }
</script>

<!-- Function to copy text to clipboard -->
<script>
    function CopyToClipboard(id) {
        var r = document.createRange();
        r.selectNode(document.getElementById(id));
        window.getSelection().removeAllRanges();
        window.getSelection().addRange(r);
        document.execCommand('copy');
        window.getSelection().removeAllRanges();
    }
</script>

</html>
</body>

{% endblock %}

