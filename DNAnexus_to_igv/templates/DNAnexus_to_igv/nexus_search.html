{% extends 'base.html' %}

{% block css %}
<style>
    .spinner{
        position: relative;
        bottom: 80px;
        left: 200px;
    }
    .text-small {
        font-size: 80%;
    }
    #custom-tooltip-1 {
        display: none;
        font-size: 10px;
        padding: 5px 12px;
        background-color: #4BB543;
        border-radius: 4px;
        color: #FFF;
    }
    #custom-tooltip-2 {
        display: none;
        font-size: 10px;
        padding: 5px 12px;
        background-color: #4BB543;
        border-radius: 4px;
        color: #FFF;
    }
</style>
{% endblock %}

{% block body %}
{% load crispy_forms_tags %}
<div class="container p-5 mb-5">
    <div class="card p-2">
        <div class="card-body">
            <h2>DNAnexus to IGV</h2></br>
    
            Currently only newly sequenced samples processed through DNAnexus will be available to view through this instance of IGV.<br></br>
        
            This page may be used to generate URLs to view BAMs on IGV installed locally on your PC, or to view directly within IGV on Genetics Ark. <br></br>
        
            Enter the sample ID (e.g. X010000) in the search box and click search, this will return links to paste in to IGV if installed locally <br>
            on the PC, or a button to view the BAM in the web based IGV on Genetics Ark.<br></br>
        
            The IGV user guide may be found <a href="https://software.broadinstitute.org/software/igv/UserGuide" target="_blank">here</a>.<br></br>
        
            <!-- form for main search -->
            <form method="post" action="" name="search_form" onsubmit="return spinner_function()">
                {% csrf_token %}
                {{ search_form|crispy }}<br>
                <button name="search_form" id="search" type="submit" class="btn btn-primary btn-sm">Search</button>
            </form>
        
            <!-- loading spinner -->
            <div id="spinner" class="spinner" style="display:none">
                <img id='spinner' src='/static/images/cloud2.gif' alt="Please wait .."  style="width:75px;height:50px;"> 
                <b>Searching DNAnexus for samples</b>
            </div>
            
            <!-- IF NORMAL SEARCH FIELD USED, REMOVE DIRECT LINK FIELDS -->
            {% if not bam_name and not bam_list %}
                <h3 class="mt-5">Load direct from URL</h3>
        
                To load BAMs directly in to IGV hosted on Genetics Ark please paste the BAM and index url in the respective fields below.
                This may be used for viewing samples outside of standard seqencing runs (i.e. during development work) where 
                DNAnexus links have been provided by the bioinformatics team.
        
                <!-- form for direct links -->
                <form method="post" action=""  name="url_form" >
                    {% csrf_token %}
                    {{ url_form|crispy }}
                    <div class="row">
                        <button name="url_form_37" type="submit" class ="btn btn-primary btn-sm m-2 px-3">View in web IGV <br>(GRCh37)</button>
                        <button name="url_form_38" type="submit" class ="btn btn-info btn-sm m-2 px-3">View in web IGV <br>(GRCh38)</button>
                    </div>
                </form>
            {% endif %}
            
            <!-- SINGLE SAMPLE VIEW -->
            {% if bam_name %}
                <h2 class="mt-5">{{ bam_name}}</h2>
                Search Term: <b>{{ sampleID }}</b><br>
                Sample Name: <b>{{ bam_name }}</b><br>
                Sequencing Project: <b>{{ project_name }}</b>
                
                <br></br>
                BAMs may be viewed on IGV installed on PC by going to File -> Load from URL, and pasting the following links:
                <br></br>
                
                <ul class="list-group">
                    <li class="list-group-item">
                        <span class="font-italic text-small" id="bam-url">{{ bam_url }}</span>
                        <input type="image" class="ml-1 m-y-0 p-0" src="/static/images/clipboard.png" onclick="copyToClipboard('bam-url', 1)" width="20" height="20"/>
                        <span id="custom-tooltip-1">copied</span>
                    </li>
                    <li class="list-group-item">
                        <span class="font-italic text-small" id="idx-url">{{ idx_url }}</span>
                        <input type="image" class="ml-1 m-y-0 p-0" src="/static/images/clipboard.png" onclick="copyToClipboard('idx-url', 2)" width="20" height="20"/>
                        <span id="custom-tooltip-2">copied</span>
                    </li>
                  </ul>
        
                <br>
                Load BAMs for sample in web IGV with appropriate reference build: 
                <br></br>
        
                <form action="" method="POST" name="igv_form" onsubmit="return checkProject()" target="_blank">
                    {% csrf_token %}
                    <input type="hidden" name="project_name" value={{ project_name }}>
                    <button name="igv_ga_37" type="submit" class ="btn btn-primary btn-sm m-2 px-3">View in web IGV <br>(GRCh37)</button>
                    <button name="igv_ga_38" type="submit" class ="btn btn-info btn-sm m-2 px-3">View in web IGV <br>(GRCh38)</button>
                </form>
            {% endif %}
        
            <!-- MULTIPLE SAMPLES VIEW-->
            {% if bam_list %}
            <h2 class="mt-5">Results</h2>
            <b>{{ bam_no}}</b> BAMs found for sample <b>{{ sampleID }}</b><br>
            Please select which project to load the BAM from:</b><br></b><br>
            
                {% for bam in bam_list %}
                    <div class="card p-2 my-2">
                        <div class="card-body">
                            <h5 class="card-title">{{ bam.bam_name }}</h5>
                            <h6 class="card-subtitle mb-2 text-muted">{{ bam.project_name }}</h6>
                            <p class="card-text"><span class="font-weight-bold">Directory:</span> {{ bam.bam_folder }}</p>
                            <form action="" method="post" name="select_bam" target="_blank">
                                {% csrf_token %}
                                <input type="hidden" name="selected_bam" value={{ bam.bam_name }} >
                                <button name="select_bam" type="submit" class = "btn btn-success btn-sm">Select</button>&emsp;
                            </form>
                        </div>
                    </div>
                {% endfor %}
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block script %}
<script type="text/javascript">
    //function to check if selected sample is in the dev data project and req. confirmation to load
    function checkProject() {
        var x = document.forms["igv_form"]["project_name"].value;
        if (x.includes("dev")) {
            if (confirm("The selected data is for development use and must not be used for service work.\n Please confirm if you still want to load IGV.")) {
                confirm = true;
            } else {
                confirm = false;
            }
            return confirm;
        }
    }

    //function to display loading spinner on form submit
    function spinner_function() {
        var x = document.getElementById("spinner");
        if (x.style.display === "none") 
            {x.style.display = "block";}
        else 
            {x.style.display = "none";}
    }

    //Function to copy text to clipboard
    //Credit: https://stackoverflow.com/questions/22581345/click-button-copy-to-clipboard
    //Credit: https://stackoverflow.com/questions/61092432/display-success-message-after-copying-url-to-clipboard
    function copyToClipboard(elementId, num) {
        // Create a "hidden" input
        var aux = document.createElement("input");
        // Assign it the value of the specified element
        aux.setAttribute("value", document.getElementById(elementId).innerHTML);
        // Append it to the body
        document.body.appendChild(aux);
        // Highlight its content
        aux.select();
        // Copy the highlighted text
        document.execCommand("copy");
        // Remove it from the body
        document.body.removeChild(aux);

        if (num == 1) {
            document.getElementById("custom-tooltip-1").style.display = "inline";
            setTimeout( function() {
                document.getElementById("custom-tooltip-1").style.display = "none";
            }, 1000);
        } else {
            document.getElementById("custom-tooltip-2").style.display = "inline";
            setTimeout( function() {
                document.getElementById("custom-tooltip-2").style.display = "none";
            }, 1000);
        }
    }
</script>
{% endblock %}
